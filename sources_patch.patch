From 496a07d58bc4dbcd8a161b089628a2c3152e334c Mon Sep 17 00:00:00 2001
From: plgcwiertni <cwiertnia.michal@gmail.com>
Date: Tue, 19 Jun 2018 10:52:53 +0200
Subject: [PATCH] VFS-3989 Added sources to patch

---
 charts/stable/oneprovider/templates/deployment.yaml | 55 ++++++++++++++++++++++++++++
 charts/stable/stable/onezone/templates/deployment.yaml     | 53 +++++++++++++++++++++++++++
 2 files changed, 108 insertions(+)

diff --git a/charts/stable/oneprovider/templates/deployment.yaml b/charts/stable/oneprovider/templates/deployment.yaml
index e451a38..c022596 100644
--- a/charts/stable/oneprovider/templates/deployment.yaml
+++ b/charts/stable/oneprovider/templates/deployment.yaml
@@ -153,6 +153,10 @@ spec:
             echo {{ template "fullname" . }}-{{ sub (.Values.oneprovider_nodes_count) 1 }} ;
             if [[ "$HOSTNAME" != {{ template "fullname" . }}-{{ sub (.Values.oneprovider_nodes_count) 1 }} ]]; then export ONEPANEL_BATCH_MODE="false" ; fi ;
             env ;
+            {{- if .Values.sources }}
+              python {{ $.Values.vmPathPrefix }}/{{ $.Values.deploymentDir }}/parse_sources.py  {{ $.Values.vmPathPrefix }}/{{ $.Values.deploymentDir }} ;
+              if [[ -f onepanel_override ]]; then export ONEPANEL_OVERRIDE=$(cat onepanel_override) ; fi ;
+            {{ end }}
             /root/oneprovider.sh ;
             cat /var/log/op_panel/info.log ;
             exit 1 ;
@@ -177,6 +181,18 @@ spec:
                 onepanel_ready() { sleep 5 ; exit 0 ; } ;
                 if [[ "$HOSTNAME" == {{ template "fullname" . }}-{{ sub (.Values.oneprovider_nodes_count) 1 }} ]]; then exit 0 ; else onepanel_ready ; fi ;
         env:
+          - name: SERVICE_NAME
+            {{ if .Values.name }}
+            value: {{ .Values.name }}
+            {{- else -}}
+            value: {{ template "fullname" $ }}
+            {{- end }}
+          - name: POD_IP
+            valueFrom:
+              fieldRef:
+                fieldPath: status.podIP
+          - name: SERVICE_DOMAIN
+            value: {{ template "service_url" $ }}
           - name: ONEPANEL_LOG_LEVEL
             value: {{ default "info" .Values.log_level | quote }}
           - name: ONEPANEL_GENERATE_TEST_WEB_CERT
@@ -193,6 +209,23 @@ spec:
                 name: {{ template "fullname" . }}-config
                 key: ONEPROVIDER_CONFIG
         volumeMounts:
+          {{- if .Values.sources }}
+          - mountPath: {{ $.Values.hostPathPrefix }}/{{ $.Values.deploymentDir }}
+            name: deployment-dir
+            {{- range $.Values.sources }}
+              {{- if .hostPath }}
+            # Mount sources. Again for all pods (nodes) all sources will be mounted.
+          - mountPath: {{ $.Values.hostPathPrefix }}/{{ .hostPath }}
+            name: {{ .name }}
+            # Mount data dir. It will be filled with data from scenario_runner
+          - mountPath: {{ $.Values.hostPathPrefix }}/{{ .hostPath }}/_build/default/rel
+            name: sources-{{ .name }}
+              {{ else }}
+          - mountPath: /tmp/{{ .name }}
+            name: sources-{{ .name }}
+              {{ end }}
+            {{ end }}
+          {{ end }}
           - name: config-map
             mountPath: /etc/op_panel/overlay.config
             subPath: panel-overlay.config
@@ -261,6 +294,28 @@ spec:
         {{- end }}
       {{- end }}
       volumes:
+    {{- if .Values.sources }}
+      - name: deployment-dir
+        hostPath:
+          path: {{ $.Values.vmPathPrefix }}/{{ $.Values.deploymentDir }}
+      # Sources. For each pod (node) all sources will be the mounted.
+      {{- range $.Values.sources }}
+        {{- if .hostPath }}
+      - name: {{ .name }}
+        hostPath:
+          path: {{ $.Values.vmPathPrefix }}/{{ .hostPath }}
+      # Random directory for each source. It is needed to store data. Each pod (node)
+      # will have different random directories.
+        {{- end }}
+      - name: sources-{{ .name }}
+        hostPath:
+          {{ if eq $.Values.suffix "" }}
+          path: {{ $.Values.vmPathPrefix }}/{{ $.Values.deploymentDir }}/oneprovider/{{ .name }}
+          {{ else }}
+          path: {{ $.Values.vmPathPrefix }}/{{ $.Values.deploymentDir }}/oneprovider-{{- $.Values.suffix -}}/{{ .name }}
+          {{ end }}
+      {{- end }}
+    {{- end }}
       - name: config-map
         configMap:
           name: {{ template "fullname" . }}-config
diff --git a/charts/stable/onezone/templates/deployment.yaml b/charts/stable/onezone/templates/deployment.yaml
index 0597aac..aec6076 100644
--- a/charts/stable/onezone/templates/deployment.yaml
+++ b/charts/stable/onezone/templates/deployment.yaml
@@ -153,6 +153,10 @@ spec:
             echo {{ template "fullname" . }}-{{ sub (.Values.onezone_nodes_count) 1 }} ;
             if [[ "$HOSTNAME" != {{ template "fullname" . }}-{{ sub (.Values.onezone_nodes_count) 1 }} ]]; then export ONEPANEL_BATCH_MODE="false" ; fi ;
             env ;
+            {{- if .Values.sources }}
+               python {{ $.Values.vmPathPrefix }}/{{ $.Values.deploymentDir }}/parse_sources.py  {{ $.Values.vmPathPrefix }}/{{ $.Values.deploymentDir }} ;
+               if [[ -f onepanel_override ]]; then export ONEPANEL_OVERRIDE=$(cat onepanel_override) ; fi ;
+            {{ end }}
             /root/onezone.sh ;
             cat /var/log/oz_panel/info.log ;
             exit 1 ;
@@ -191,6 +195,20 @@ spec:
             value: {{ default "false" .Values.onepanel_trust_test_ca | quote }}
           - name: ONEPANEL_BATCH_MODE
             value: {{ .Values.onepanel_batch_mode_enabled | quote }}
+          - name: SERVICE_NAME
+            {{ if .Values.name }}
+            value: {{ .Values.name }}
+            {{- else -}}
+            value: {{ template "fullname" $ }}
+            {{- end }}
+          - name: POD_IP
+            valueFrom:
+              fieldRef:
+                fieldPath: status.podIP
+          - name: SERVICE_DOMAIN
+            value: {{ template "service_url" $ }}
+          - name: ONEPANEL_LOG_LEVEL
+            value: {{ default "info" .Values.log_level | quote }}
           - name: ONEZONE_CONFIG
             valueFrom:
               configMapKeyRef:
@@ -203,6 +221,23 @@ spec:
           - name: config-map
             mountPath: /etc/oz_worker/overlay.config
             subPath:  worker-overlay.config
+      {{- if .Values.sources }}
+          - mountPath: {{ $.Values.hostPathPrefix }}/{{ $.Values.deploymentDir }}
+            name: deployment-dir
+        {{- range $.Values.sources }}
+          {{- if .hostPath }}
+          # Mount sources. Again for all pods (nodes)all sources will be mounted.
+          - mountPath: {{ $.Values.hostPathPrefix }}/{{ .hostPath }}
+            name: {{ .name }}
+         # Mount data dir. It will be filled with data from scenario_runner
+          - mountPath: {{ $.Values.hostPathPrefix }}/{{ .hostPath }}/_build/default/rel
+            name: sources-{{ .name }}
+          {{ else }}
+          - mountPath: /tmp/{{ .name }}
+            name: sources-{{ .name }}
+          {{ end }}
+        {{ end }}
+      {{ end }}
       {{- if (index .Values "generate-certificates" "enabled") }}
           - mountPath: /etc/oz_panel/certs/web_key.pem
             subPath: tls.key
@@ -238,6 +273,24 @@ spec:
             name: config-map
             readOnly: true
       volumes:
+    {{- if .Values.sources }}
+      - name: deployment-dir
+        hostPath:
+          path: {{ $.Values.vmPathPrefix }}/{{ $.Values.deploymentDir }}
+      # Sources. For each pod (node) all sources will be the mounted.
+      {{- range $.Values.sources }}
+        {{- if .hostPath }}
+      - name: {{ .name }}
+        hostPath:
+          path: {{ $.Values.vmPathPrefix }}/{{ .hostPath }}
+     # Random directory for each source. It is needed to store data. Each pod (node)
+     # will have different random directories.
+        {{- end }}
+      - name: sources-{{ .name }}
+        hostPath:
+          path: {{ $.Values.vmPathPrefix }}/{{ $.Values.deploymentDir }}/onezone/{{ .name }}
+      {{- end }}
+    {{ end }}
       - name: config-map
         configMap:
           name: {{ template "fullname" . }}-config
-- 
2.7.4

